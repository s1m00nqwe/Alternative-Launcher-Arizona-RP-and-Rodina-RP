import './style.css';
import './app.css';
import { EventsOn, EventsEmit } from '../wailsjs/runtime'
import { config, loadConfig, saveConfig, parameterName, togglePasswordVisibility, FavoriteServer } from './config';
import { StartGame, UpdateServerInfo } from '../wailsjs/go/main/App';

type Server = {
    number:               number,
	name:                 string,
	ip:                   string,
	port:                 number,
	online:               number,
	maxplayers:           number,
	password:             boolean,
	vk:                   string,
	tg:                   string,
	inst:                 string,
	icon:                 string,
	additionalIps:        string[],
	donateMultiplier:     number,
	experienceMultiplier: number,
	plotPoints:           {online: number, time: number}[]
}

var serversList: Server[] = [];
var arizonaServers: Server[] = [];
var rodinaServers: Server[] = [];
var mobileServers: Server[] = [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–µ—Ä–≤–µ—Ä –∏–∑–±—Ä–∞–Ω–Ω—ã–º
function isServerFavorite(server: Server, serverType: string): boolean {
    return config.favoriteServers.some(fav => 
        fav.number === server.number && fav.serverType === serverType
    );
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleFavorite(server: Server, serverType: string) {
    const existingIndex = config.favoriteServers.findIndex(fav => 
        fav.number === server.number && fav.serverType === serverType
    );

    if (existingIndex > -1) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        config.favoriteServers.splice(existingIndex, 1);
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        const favoriteServer: FavoriteServer = {
            number: server.number,
            name: server.name,
            ip: server.ip,
            port: server.port,
            online: server.online,
            maxplayers: server.maxplayers,
            icon: server.icon,
            serverType: serverType
        };
        config.favoriteServers.unshift(favoriteServer); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
    }
    
    saveConfig();
    updateServersDisplay(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
}

function createServer(server: Server, id: number, isSelected = false, hideNumber = false, serverType = 'arizona') {
    const list = document.getElementById('servers-list');
    const serverDiv = document.createElement('div');
    serverDiv.classList.add('server');
    if (isSelected) serverDiv.classList.add('server-selected');
    serverDiv.id = `${serverType}-${id}`;
    
    const isFavorite = isServerFavorite(server, serverType);
    
    const serverLogo = document.createElement('img');
    serverLogo.classList.add('server-logo')
    serverLogo.src = server.icon;

    const serverId = document.createElement('a');
    serverId.classList.add('server-id');
    serverId.textContent = `#${server.number}`;

    const serverName = document.createElement('a');
    serverName.classList.add('server-name');
    serverName.textContent = server.name;

    const serverPlayers = document.createElement('a');
    serverPlayers.id = `players-count-${server.number}`
    serverPlayers.classList.add('server-players');
    serverPlayers.textContent = `${server.online}/${server.maxplayers}`;
    
    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–¥–µ—á–∫–æ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const favoriteHeart = document.createElement('div');
    favoriteHeart.classList.add('favorite-heart');
    favoriteHeart.innerHTML = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
    favoriteHeart.style.cursor = 'pointer';
    favoriteHeart.style.marginLeft = 'auto';
    favoriteHeart.style.marginRight = '5px';
    favoriteHeart.style.fontSize = '14px';
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ
    favoriteHeart.addEventListener('click', (e) => {
        e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        toggleFavorite(server, serverType);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–∞–º —Å–µ—Ä–≤–µ—Ä
    serverDiv.onclick = () => {
        document.querySelectorAll('.server').forEach((el) => {
            el.classList.remove('server-selected');
        });
        serverDiv.classList.add('server-selected');
        UpdateServerInfo(server.ip);
        config.selectedServer = server.number;
        config.serverType = serverType;
        saveConfig();
    };
    
    serverDiv.appendChild(serverLogo);
    if (!hideNumber)
        serverDiv.appendChild(serverId);
    serverDiv.appendChild(serverName);
    serverDiv.appendChild(favoriteHeart); // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–¥–µ—á–∫–æ –ø–µ—Ä–µ–¥ —Å—á–µ—Ç—á–∏–∫–æ–º –∏–≥—Ä–æ–∫–æ–≤
    serverDiv.appendChild(serverPlayers);
    list?.appendChild(serverDiv);
}

function createServerSection(title: string, servers: Server[], type: string) {
    const list = document.getElementById('servers-list');
    const sectionDiv = document.createElement('div');
    sectionDiv.classList.add('server-section');
    
    const sectionTitle = document.createElement('div');
    sectionTitle.classList.add('server-section-title');
    sectionTitle.textContent = title;
    sectionDiv.appendChild(sectionTitle);
    
    list?.appendChild(sectionDiv);
    
    servers.forEach((server) => {
        createServer(server, server.number, 
            config.selectedServer == server.number && config.serverType == type, 
            false, type);
    });
}

// –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
function createFavoriteSection() {
    if (config.favoriteServers.length === 0) return;
    
    const list = document.getElementById('servers-list');
    const sectionDiv = document.createElement('div');
    sectionDiv.classList.add('server-section');
    
    const sectionTitle = document.createElement('div');
    sectionTitle.classList.add('server-section-title');
    sectionTitle.textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
    sectionDiv.appendChild(sectionTitle);
    
    list?.appendChild(sectionDiv);
    
    config.favoriteServers.forEach((favServer) => {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç Server –∏–∑ FavoriteServer
        const server: Server = {
            number: favServer.number,
            name: favServer.name,
            ip: favServer.ip,
            port: favServer.port,
            online: favServer.online,
            maxplayers: favServer.maxplayers,
            password: false,
            vk: '',
            tg: '',
            inst: '',
            icon: favServer.icon,
            additionalIps: [],
            donateMultiplier: 1,
            experienceMultiplier: 1,
            plotPoints: []
        };
        
        createServer(server, favServer.number, 
            config.selectedServer == favServer.number && config.serverType == favServer.serverType, 
            false, favServer.serverType);
    });
}

function updateServersDisplay() {
    const list = document.getElementById('servers-list');
    if (list) list.innerHTML = '';

    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
    createFavoriteSection();
    
    // –ó–∞—Ç–µ–º –æ–±—ã—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
    if (arizonaServers.length > 0) {
        createServerSection('Arizona RP', arizonaServers, 'arizona');
    }
    
    if (mobileServers && mobileServers.length > 0) {
        createServerSection('Arizona Mobile', mobileServers, 'arizonaMobile');
    }
    
    if (rodinaServers && rodinaServers.length > 0) {
        createServerSection('Rodina RP', rodinaServers, 'rodina');
    }
}

function showSettingsDialog() {
    const dialog = document.getElementById('dialog-settings') as HTMLDialogElement;
    if (dialog) {
        dialog.showModal();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
function initializeApp() {
    loadConfig();
    EventsEmit('servers:request');
    
    setInterval(() => {
        console.log('Requesting servers update...');
        EventsEmit('servers:request');
    }, 10000);
    
    document.querySelectorAll('input[type=checkbox]').forEach((el) => el.addEventListener('click', () => {
        //@ts-ignore
        config.params[el.id] = el.checked
        saveConfig();
    }));
    
    //@ts-ignore
    document.getElementById('button-settings')?.addEventListener('click', showSettingsDialog);
    
    const nameInput = document.getElementById('name');
    nameInput?.addEventListener('input', () => {
        //@ts-ignore
        config.name = nameInput.value;
    });
    
    document.getElementById('path')?.addEventListener('click', () => EventsEmit('settings:requestFileDialog', 'arizona'))
    document.getElementById('rodina-path')?.addEventListener('click', () => EventsEmit('settings:requestFileDialog', 'rodina'))
    document.getElementById('toggle-password')?.addEventListener('click', togglePasswordVisibility);
    
    document.getElementById('button-play')?.addEventListener('click', () => {
        saveConfig();
        
        let selectedServer: Server;
        
        // –í—ã–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–µ—Ä –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        if (config.serverType === 'rodina') {
            selectedServer = rodinaServers.find((s) => s.number == config.selectedServer) ?? rodinaServers[0];
        } else if (config.serverType === 'arizonaMobile') {
            selectedServer = mobileServers.find((s) => s.number == config.selectedServer) ?? mobileServers[0];
        } else {
            selectedServer = arizonaServers.find((s) => s.number == config.selectedServer) ?? arizonaServers[0];
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏–≥—Ä–µ
        let gamePath = config.path;
        if (config.serverType === 'rodina' && config.rodinaPath) {
            gamePath = config.rodinaPath;
        }
        
        if (!gamePath) {
            alert('–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –∏–≥—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!');
            showSettingsDialog();
            return;
        }
        
        let params: string[] = [];
        
        if (config.serverType === 'rodina') {
            // –î–ª—è Rodina –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            params = [
                '-c',
                `-h ${selectedServer.ip}`,
                `-p ${selectedServer.port}`,
                `-n ${config.name}`,
                '-rodina',
                '-z',
                `-mem ${config.memory.toString().length > 0 ? config.memory : '4096'}`,
                '-ldo'
            ];
            console.log('Selected Rodina server:', selectedServer.ip);
        } else {
            // –î–ª—è Arizona –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            params = [
                '-c',
                '-arizona',
                `-h ${selectedServer.ip}`,
                `-p ${selectedServer.port}`,
                `-n ${config.name}`,
                `-mem ${config.memory.toString().length > 0 ? config.memory : '2048'}`,
                '-referrer',
                '-userId undefined',
                config.pass.length > 0 ? `-z ${config.pass}` : '',
            ];
            for (const [param, value] of Object.entries(config.params)) {
                if (value) params.push(`-${parameterName[param]}`);
            }
            console.log('Selected Arizona server:', selectedServer.ip);
        }
        
        console.log('Server type:', config.serverType);
        console.log('Game path:', gamePath);
        console.log('Selected server IP:', selectedServer.ip);
        console.log('Parameters:', params.join(' '));
        
        StartGame(config.name, gamePath, params, config.serverType);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
addEventListener('DOMContentLoaded', initializeApp);

EventsOn('settings:fileDialogPathSelected', (path: string, gameType: string) => {
    if (gameType === 'rodina') {
        config.rodinaPath = path;
        // @ts-ignore
        document.getElementById('rodina-path').value = path;
    } else {
        config.path = path;
        // @ts-ignore
        document.getElementById('path').value = path;
    }
    saveConfig();
});

EventsOn('servers:update', (servers: Server[], mobileServersFromAPI: Server[], rodinaServersFromAPI: Server[]) => {
    console.log('servers:update');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã
    arizonaServers = servers;
    mobileServers = mobileServersFromAPI || [];
    rodinaServers = rodinaServersFromAPI || [];

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
    config.favoriteServers.forEach(fav => {
        let sourceServers: Server[] = [];
        
        switch (fav.serverType) {
            case 'arizona':
                sourceServers = arizonaServers;
                break;
            case 'arizonaMobile':
                sourceServers = mobileServers;
                break;
            case 'rodina':
                sourceServers = rodinaServers;
                break;
        }
        
        const currentServer = sourceServers.find(s => s.number === fav.number);
        if (currentServer) {
            fav.online = currentServer.online;
            fav.maxplayers = currentServer.maxplayers;
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateServersDisplay();

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    serversList = [...arizonaServers, ...mobileServers, ...rodinaServers];
    
    console.log('Arizona servers count:', arizonaServers.length);
    console.log('Mobile servers count:', mobileServers.length);
    console.log('Rodina servers count:', rodinaServers.length);
    console.log('Favorite servers count:', config.favoriteServers.length);
});

EventsOn('server:update_players', (host: string, players: number, maxplayers: number) => {
    const server = serversList.find((s) => s.ip == host);
    if (server) {
        const playersCount = document.getElementById(`players-count-${server.number}`);
        if (playersCount) playersCount.textContent = `${players}/${maxplayers}`;
    }
    console.log('server:update_players', host, players, maxplayers);
})